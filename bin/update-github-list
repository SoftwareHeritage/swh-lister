#!/bin/bash

# PYTHONPATH and PATH (for ghlister) should be set via cron
# export PYTHONPATH=$HOME/src/swh-lister-github/

log_dir=$(grep log_dir ~/.config/swh/lister-github.ini | cut -f 3 -d' ')
test -d "$log_dir" || mkdir -p "$log_dir"
logfile="${log_dir}/$(date +%Y%m%d).log"

# catchup with recent changes
ghlister catchup &> "$logfile"

# XXX: computing the following stats via this script forced to have double
# configuration for shell-vs-python. Also it's unneeded: we can compute the
# same information (number of repos created per day) from the DB, via the
# last_seen column.

# dbservice=lister-github
# dbconn="service=${dbservice}"
# psql="psql --no-psqlrc --pset t --pset format=unaligned ${dbconn}"

# # compute and store current totals
# all_repos=$(echo "select count(*) from repos" | $psql)
# fork_repos=$(echo "select count(*) from fork_repos" | $psql)
# orig_repos=$(echo "select count(*) from orig_repos" | $psql)
# echo "insert into repos_history(repos, fork_repos, orig_repos) values (${all_repos}, ${fork_repos}, ${orig_repos})" | $psql > /dev/null
